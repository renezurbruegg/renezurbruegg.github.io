<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>test-app documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	      <link rel="stylesheet" href="../styles/style.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">test-app documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">












<ol class="breadcrumb">
  <li>Interfaces</li>
  <li>DataEntry</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/m-dashboard/chart/chart.component.ts</code>
        </p>

            <p class="comment">
                <h3>Description</h3>
            </p>
            <p class="comment">
                <p>Interfaces that defines the ResponseObject of the VoltageUpdate Subscription</p>

            </p>


        <section>
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                        <a href="#max">max</a>
                                </li>
                                <li>
                                        <a href="#unit">unit</a>
                                </li>
                                <li>
                                        <a href="#value">value</a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section>
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="max"></a>
                                        <span class="name"><b>max</b><a href="#max"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>max:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                            <tr>
                                <td class="col-md-4">
                                    <div class="io-description"><p>Max Value that is possible to send in this resolution =&gt; used to scale the graph</p>
</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="unit"></a>
                                        <span class="name"><b>unit</b><a href="#unit"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>unit:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                            <tr>
                                <td class="col-md-4">
                                    <div class="io-description"><p>e.g. V, mV, mA, uA</p>
</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="value"></a>
                                        <span class="name"><b>value</b><a href="#value"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>value:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                            <tr>
                                <td class="col-md-4">
                                    <div class="io-description"><p>The value for this measurement</p>
</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Component, OnInit, AfterViewInit, Input, OnDestroy, ChangeDetectorRef } from &#x27;@angular/core&#x27;;
import { Chart } from &#x27;chart.js&#x27;;
import { MeasurementUpdateService } from &#x27;../../_services/MeasurementUpdateService&#x27;;
import { AppConfig } from &#x27;../../_services/app.config&#x27;;

import { ChartDataset } from &#x27;../../_models/chartDataset.model&#x27;;
import { ChartObject } from &#x27;../../_models/chartObject.model&#x27;;
import { HttpClient } from &#x27;@angular/common/http&#x27;;
import { Subscription } from &#x27;rxjs&#x27;;
import { ToastrService } from &#x27;ngx-toastr&#x27;;




/**
* Interfaces that defines the ResponseObject of the VoltageUpdate Subscription
*/
interface DataEntry {
  /**
  * Max Value that is possible to send in this resolution &#x3D;&gt; used to scale the graph
  */
   max: number;
   /**
   * e.g. V, mV, mA, uA
   */
   unit:string;
   /**
   * The value for this measurement
   */
   value:number;
}

export function scaleToSiUnit(data:DataEntry):number {
      let unit &#x3D; data.unit.charAt(0)
      let multiplier &#x3D; 1;

      if (unit &#x3D;&#x3D; &quot;m&quot;) {
        multiplier &#x3D;  1/1000;
      } else if(unit &#x3D;&#x3D; &quot;u&quot;) {
        multiplier &#x3D; 1/1000000
      }
      return data.value * multiplier;

  }

/**
* Component that creates a chart graph with reload, pause and export button.
* @example
*
* | ----------------------------------------------------------------|
* |                                        [Play][Reload][export]   |
* |        |---------------------------------|                      |
* |        |                                 |                      |
* |        |     Chart JS (chartObject)      |                      |
* |        |                                 |                      |
* |        |                                 |                      |
* |        |---------------------------------|                      |
* |                                                                 |
* | ----------------------------------------------------------------|
*
*/
@Component({
  selector: &#x27;app-chart&#x27;,
  templateUrl: &#x27;./chart.component.html&#x27;,
  styleUrls: [&#x27;./chart.component.css&#x27;]
})

export class ChartComponent implements OnInit, AfterViewInit, OnDestroy {

  /**
  * Object that stores custom transform function for every dataset.  &lt;br&gt;
  * This is used to created custom datasets. e.g. power calculation
  */
  private dataSetHandlerFunctions: Record&lt;string, (data: any) &#x3D;&gt; number&gt; &#x3D; {}
  /**
  * the chartobject stored in the config which contains all the information about this chart. (name, datasets etc.)
  */
  @Input()
  public chartObject: ChartObject;

  /**
  *  boolean that stores state of graph.
  */
  public paused: boolean &#x3D; false;
  // message: any;

  private subscription: Subscription;

  // public currValue: string;

  /**
  * Holds the real Chart.js chart objects.
  */
  public chartLine: Chart;

  /**
  * Defines how many decimal numbers we want to show.
  */
  private precision: number &#x3D; Math.pow(10, 3);


  /**
  *  Contains the last resolution for every measurement in the graph. &lt;br&gt;
  *  Used to find resolution changes and rescale values
  */
  private lastResolution: Record&lt;string, string&gt; &#x3D; {}

  /**
  * Contains all the data that will be passed to the chart objects.
  */
  private data &#x3D; {
    labels: [&quot;&quot;],
    datasets: []
  };


  /**
  * Contains mapping axis id to axis position in chart.js options
  */
  idToYAxis:Record&lt;string, number&gt; &#x3D; {}

  /**
  * @param {MeasurementUpdateService} measurementUpdateService Service that polls every &lt;intervaltime&gt; and publishes new measurement values using observables
  * @param {ChangeDetectorRef} cd Angular class to notify angular about frontend changes. Needed because the graph convas doesn&#x27;t trigger changes on it&#x27;s own when set up
  * @param {HttpClient} http http client to communicate with backend
  * @param {ToastrService} toastr Service used to create small notification on the screen
  */
  constructor(private measurementUpdateService: MeasurementUpdateService, private cd: ChangeDetectorRef, private http: HttpClient,  private toastr: ToastrService) { }

  /**
  * called when component is destroyed. Unsubscribes from VoltageUpdateSubscription
  */
  ngOnDestroy() {
    this.subscription.unsubscribe();
  }

  /**
  * Sets up a subscription from measurementUpdateService. &lt;br&gt;
  */
  private setUpSubscription() {

    // Add all datasets to chart
    for (let dataset of this.chartObject.datasets) {
      this.addDatasetToChart(dataset);
    }

    // Every time a measurement update is triggered call addDataToChart function
    this.subscription &#x3D; this.measurementUpdateService.getVoltageUpdateObs(this.chartObject.chartId)
                                                 .subscribe(data &#x3D;&gt; this.addDataToChart(data));

    // Notify service that we subscribed.
    this.measurementUpdateService.notifySubscribe();
  }

  /**
  * Called when component is created. Sets up a subscription from measurementUpdateService to get measurement Updates
  */
  ngOnInit() {
    this.setUpSubscription()
  }

  /**
  * After view element is created.  &lt;br&gt;
  *  Sets up Chart.js element (chartLine)
  */
  ngAfterViewInit() {
    // load options from general config
    let options &#x3D; AppConfig.settings.general.chartOptions;

    // Check if there are own options set for this particular graph.
    if (this.chartObject.hasOwnProperty(&quot;options&quot;)) {
      options &#x3D; this.chartObject.options;
    }

    this.setUpAxesConfig(options.scales.yAxes);

    // Set up Chart.js chart
    this.chartLine &#x3D; new Chart(this.chartObject.chartId, {
      type: &#x27;line&#x27;,
      data: this.data,
      options: options
    });
    // default value
    this.paused &#x3D; false;

    // Notify angular that we changed stuff
    this.cd.detectChanges();
  }



/**
* Adds data obtained from measurementUpdateService to the graph. &lt;br&gt;
* @param { Record&lt;string, DataEntry&gt;} data Record containg all measurements from backend
*/
  private addDataToChart(data: Record&lt;string, DataEntry&gt;): void {

    // Every dataset can decide which data it wants to use.
    for (let dataset of this.chartObject.datasets) {

      let datasetId &#x3D; dataset.datasetId;
      let unit &#x3D; dataset.unit;

      // get value from datasetHandlerFunction. Scale it to precision


      let value &#x3D; Math.round(this.dataSetHandlerFunctions[datasetId](data) * this.precision) / this.precision;

      let lastUnit &#x3D; this.lastResolution[dataset.datasetId];

      if (!dataset.chartDataset.data) {
        dataset.chartDataset.data &#x3D; [];
      }

      // Check if units changed. If yes, rescale all old values.
      let dataCount &#x3D; dataset.chartDataset.data.length;
      if (lastUnit  &amp;&amp; lastUnit !&#x3D; &quot;&quot; &amp;&amp; lastUnit !&#x3D; unit &amp;&amp; dataCount) {
          // We got a resolution change. Figure out if we need to down or upscale values
          let multiplier &#x3D; 1;
          if (unit &#x3D;&#x3D; &quot;mV&quot; || unit &#x3D;&#x3D; &quot;uA&quot;) {
            // V -&gt; mV
            multiplier &#x3D; 1000;
          } else if (unit &#x3D;&#x3D; &quot;V&quot; || unit &#x3D;&#x3D; &quot;mA&quot;) {
            // mV -&gt; V
            multiplier &#x3D; 1 / 1000;
          }

          // recalculate all old datas
          for (let i &#x3D; 0; i &lt; dataCount; i++) {
            dataset.chartDataset.data[i] &#x3D; dataset.chartDataset.data[i] * multiplier;
          }

          lastUnit &#x3D; unit
      }


      // Add value to graph.
      dataset.chartDataset.data.push(value);
      dataset.chartDataset.currValue &#x3D; value;


      // If we reached max items shift() data array so do not show too many points.
      if (dataset.chartDataset.data.length &gt;&#x3D; this.chartObject.maxValues) {
        dataset.chartDataset.data.shift();
      }

      // Create label from datasetName and unit if option is enabled
      if (dataset.autoLabel) {
        dataset.unit &#x3D; data[dataset.sourceId].unit;
        dataset.chartDataset.label &#x3D; dataset.name + &quot;[&quot; + unit + &quot;]&quot;;
      }

      // Rescale Axis
      if (dataset.chartDataset.yAxisID &amp;&amp; (dataset.autoRange || dataset.negRange)) {
        // Get Axis from mapping
        let axis &#x3D; this.chartLine.options.scales.yAxes[this.idToYAxis[dataset.chartDataset.yAxisID]]
        if (dataset.autoRange) {
          axis.ticks.max &#x3D; data[dataset.sourceId].max
          axis.ticks.min &#x3D; 0
        }

        if (dataset.negRange) {
          axis.ticks.min &#x3D; -data[dataset.sourceId].max;
        }
      }

    }

    // We need to push a label for the x-axis. in this case it is empty, so we do not write anything
    // If nothing is pushed, graph won&#x27;t show new values
    this.data.labels.push(&#x27;&#x27;);

    // shift labels if maxvalues reached
    if (this.data.labels.length &gt; this.chartObject.maxValues) {
      this.data.labels.shift();
    }

    // notify update
    this.chartLine.update()
  }

  /**
  * Adds a new dataset to the chart.  Only call this function once when setting up a new dataset.
  * @param {ChartDataset} dataset The Dataset object we want to add to the chart.
  */
  private addDatasetToChart(dataset: ChartDataset) {
    // Register in lastResolution array
    this.lastResolution[dataset.datasetId] &#x3D; &quot;&quot;;
    // Register as a dataset for this graph
    this.data.datasets.push(dataset.chartDataset);

    // Set up custom handler function if this is a &quot;fake Dataset&quot;.
    if (dataset.customDataHandlerEnabled) {
      this.dataSetHandlerFunctions[dataset.datasetId] &#x3D; function(data: DataEntry) {

        return eval(dataset.handler)
        // return scaleToSiUnit(data[&#x27;vm1&#x27;]) * scaleToSiUnit(data[&#x27;cm3&#x27;]);
      }
    } else {
      // just return the value.
      this.dataSetHandlerFunctions[dataset.datasetId] &#x3D; function(data: DataEntry) {
        return data[dataset.sourceId].value;
      }
    }
  }



  /**
  * Removes all points from Graph. &lt;br&gt;
  */
  public clear() {
    for (let dataset of this.chartObject.datasets) {
      dataset.chartDataset.data &#x3D; [];
      this.lastResolution[dataset.datasetId] &#x3D; &quot;&quot;;
    }

    this.data.labels &#x3D; [];
    this.chartLine.update();

    if (this.paused) {
      this.togglePlay();
    }
  }

  /**
  * Exports the current graph as image. Sends image as base64 string to the backend.
  */
  public exportImage() {
    this.http.post(AppConfig.apiUrl + &quot;/storeImage&quot;, { &quot;image&quot;: this.chartLine.ctx.canvas.toDataURL() }, { responseType: &#x27;text&#x27; })
      .subscribe(
        (val) &#x3D;&gt; {
          this.toastr.success(&#x27;Image exported&#x27;);
       },
        response &#x3D;&gt; {
         this.toastr.error(response, &quot;Could not export Image&quot;);
        });
  }



  /**
  * sets up the axis of the chart.
  */
  private setUpAxesConfig(axes:Array&lt;any&gt;) {
    axes.length &#x3D; 0;

    if(this.chartObject.axes) {
      let i &#x3D; 0;
      for (let axis of this.chartObject.axes) {
        var entry &#x3D; {
              id: axis.id,
              type: &quot;linear&quot;,
              position: axis.position,
              ticks: {}
          }

        axes.push(entry)
        this.idToYAxis[axis.id] &#x3D; i++;
      }
    }
  }
  /**
  * TODO
  */
  public exportCsv() {
    console.log(&quot;exp csv&quot;)
    let obj:Record&lt;string,Array&lt;any&gt;&gt; &#x3D; {};
    for (let dataset of this.chartObject.datasets) {
      obj[dataset.name] &#x3D; dataset.chartDataset.data
    }
    this.http.post(AppConfig.apiUrl + &quot;/storeCsv&quot;, obj, { responseType: &#x27;text&#x27; })
      .subscribe(
        (val) &#x3D;&gt; {
          this.toastr.success(&#x27;CSV exported&#x27;);
       },
        response &#x3D;&gt; {
         this.toastr.error(response, &quot;Could not export CSV&quot;);
        });
  }

  /**
  * halts / resumes adding of values to the graph.
  */
  public togglePlay() {
    //console.log(&quot;play called&quot;)
    if (!this.paused) {
      this.paused &#x3D; true;
      this.subscription.unsubscribe();
      this.measurementUpdateService.notifyUnsubscribe();
    } else {
      this.paused &#x3D; false;
      this.subscription &#x3D; this.measurementUpdateService.getVoltageUpdateObs(this.chartObject.chartId)
                                                    .subscribe(data &#x3D;&gt; this.addDataToChart(data));
      this.measurementUpdateService.notifySubscribe();
    }
  }
}
</code></pre>
    </div>
</div>






                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'DataEntry.html';
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       <!-- Required to polyfill modern browsers as code is ES5 for IE... -->
       <script src="../js/libs/custom-elements-es5-adapter.js" charset="utf-8" defer></script>
       <script src="../js/menu-wc.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
